#!/usr/bin/env -S deno run --allow-net --allow-sys --allow-read --allow-write

import { parseArgs } from "node:util";
import { readFileSync, writeFileSync, mkdirSync } from "node:fs";
import { join } from "node:path";
import { homedir } from "node:os";
import { exit } from "node:process";

const CONFIG_FILE = join(homedir(), ".config", "unsplash", "config.json");

function getConfig(): string {
  try {
    const { access_key: accessKey } = JSON.parse(readFileSync(CONFIG_FILE, "utf-8"));
    return accessKey;
  } catch {
    const key = prompt("Enter Unsplash Access Key: ");
    if (!key) exit(1);
    mkdirSync(join(homedir(), ".config", "unsplash"), { recursive: true });
    writeFileSync(CONFIG_FILE, JSON.stringify({ accessKey: key }));
    return key;
  }
}

async function search(query: string, num: number): Promise<void> {
  const key = getConfig();
  const url = `https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&per_page=${num}`;

  const res = await fetch(url, { headers: { Authorization: `Client-ID ${key}` } });
  if (!res.ok) throw new Error(`API error: ${res.status}`);

  const { results } = await res.json();

  for (const [i, p] of results.entries()) {
    const desc = p.alt_description || p.description || "No description";
    console.log(`\n[${i + 1}] ${desc}\n    By: ${p.user.name} (@${p.user.username})\n    URL: ${p.urls.full}`);
  }
}

const { values, positionals } = parseArgs({
  args: Deno.args,
  options: {
    help: { type: "boolean", default: false },
    n: { type: "string", default: "10" },
  },
  allowPositionals: true,
});
const [cmd, query] = positionals;

if (values.help || !cmd) {
  console.log(`Usage: unsplash <search|config> [query] [-n <num>]\n  search <query>  Search photos\n  config          Show config`);
  exit(0);
}

if (cmd === "config") {
  try {
    const { access_key: accessKey } = JSON.parse(readFileSync(CONFIG_FILE, "utf-8"));
    console.log(`Key: ${accessKey.slice(0, 10)}...${accessKey.slice(-4)}`);
  } catch { console.log("No config found"); }
} else if (cmd === "search") {
  await search(String(query || ""), Number(values.n));
} else {
  console.error("Unknown command. Use 'help' for usage.");
}
